cscope 15 $HOME/Workspace/Android/MyApps/AMemLeakFinder/jni               0000016065
	@backtrace.c

1 
	~<¡dio.h
>

2 
	~<¡ršg.h
>

3 
	~<unwšd.h
>

4 
	~<dlfú.h
>

5 
	~<ªdroid/log.h
>

6 
	~"backŒaû.h
"

10 ** 
	mcu¼’t
;

11 ** 
	m’d
;

12 } 
	tBackŒaûS‹
;

14 
_Unwšd_R—sÚ_Code
 
	$unwšdC®lback
(
_Unwšd_CÚ‹xt
* 
cÚ‹xt
, * 
¬g
)

16 
BackŒaûS‹
* 
¡©e
 = (BackŒaûS‹ *)
¬g
;

18 ià(
¡©e
->
cu¼’t
 < s‹->
’d
) {

20 * 

 = (*)
	`_Unwšd_G‘IP
(
cÚ‹xt
);

22 ià(

) {

23 *
¡©e
->
cu¼’t
 = 

;

24 
¡©e
->
cu¼’t
 += 1;

25  
_URC_NO_REASON
;

29  
_URC_END_OF_STACK
;

30 
	}
}

32 
size_t
 
	$ÿ±u»BackŒaû
(**
bufãr
, 
size_t
 
couÁ
)

34 
BackŒaûS‹
 
¡©e
 = {
bufãr
, bufã¸+ 
couÁ
};

36 
	`_Unwšd_BackŒaû
(
unwšdC®lback
, &
¡©e
);

38  
¡©e
.
cu¼’t
 - 
bufãr
;

39 
	}
}

41 
size_t
 
	$backŒaû
(
backŒaû_¡ack_t
 *
¡ack
, 
size_t
 
max_d•th
)

43 *
bufãr
[
MAX_BACKTRACE_DEPTH
] = {
NULL
};

44 ià(!
¡ack
)  0;

46 ià(
max_d•th
 > 
MAX_BACKTRACE_DEPTH
) {

47 
max_d•th
 = 
MAX_BACKTRACE_DEPTH
;

50 
¡ack
->
n
 = 
	`ÿ±u»BackŒaû
(
bufãr
, 
max_d•th
);

51 ià(
¡ack
->
n
 > 0) {

52 
¡ack
->
s
 = (**)
	`m®loc
((*è* sck->
n
);

53 ià(!
¡ack
->
s
) {

58 
i
 = 0; i < 
¡ack
->
n
; ++i) {

59 
¡ack
->
s
[
i
] = 
bufãr
[i];

62  
¡ack
->
n
;

63 
	}
}

66 
size_t
 
	$backŒaû
(
backŒaû_symbŞ_t
 *
symbŞs
, 
size_t
 
couÁ
)

68 
size_t
 
idx
 = 0;

69 
size_t
 
d•th
 = 0;

70 *
bufãr
[
MAX_BACKTRACE_DEPTH
] = {
NULL
};

71 
backŒaû_symbŞ_t
 *
cu¼’t
 = 
symbŞs
;

73 ià(!
cu¼’t
) {

77 ià(
couÁ
 > 
MAX_BACKTRACE_DEPTH
) {

78 
couÁ
 = 
MAX_BACKTRACE_DEPTH
;

81 
d•th
 = 
	`ÿ±u»BackŒaû
(
bufãr
, 
couÁ
);

83 
idx
 = 0; idx < 
couÁ
; ++idx, 
cu¼’t
++) {

84 cÚ¡ * 
addr
 = 
bufãr
[
idx
];

85 cÚ¡ * 
symbŞ
 = "unknown";

86 cÚ¡ * 
m­
 = "unknown";

88 ià(!
addr
) {

92 
Dl_šfo
 
šfo
;

93 ià(
	`dÏddr
(
addr
, &
šfo
)) {

94 ià(
šfo
.
dli_âame
) {

95 
m­
 = 
šfo
.
dli_âame
;

97 ià(
šfo
.
dli_¢ame
) {

98 
symbŞ
 = 
šfo
.
dli_¢ame
;

102 
cu¼’t
->
addr
 =‡ddr;

103 
cu¼’t
->
m­_Çme
 = 
	`¡rdup
(
m­
);

104 
cu¼’t
->
symbŞ_Çme
 = 
	`¡rdup
(
symbŞ
);

107  
idx
;

108 
	}
}

111 
backŒaû_symbŞ_t
* 
	$g‘BackŒaûSymbŞs
(
size_t
 
couÁ
)

113  (
backŒaû_symbŞ_t
*)
	`ÿÎoc
(
couÁ
, (backtrace_symbol_t));

114 
	}
}

116 
	$ä“BackŒaûSymbŞs
(
backŒaû_symbŞ_t
* 
symbŞs
)

118 
	`ä“
(
symbŞs
);

119 
	}
}

	@backtrace.h

1 #iâdeà
_BACK_TRACE_H


2 
	#_BACK_TRACE_H


	)

5 **
	ms
;

6 
size_t
 
	mn
;

7 } 
	tbackŒaû_¡ack_t
;

13 
ušŒ_t
 
	mabsŞu‹_pc
;

14 
ušŒ_t
 
	m¡ack_tİ
;

15 
size_t
 
	m¡ack_size
;

16 } 
	tbackŒaû_äame_t
;

22 cÚ¡ * 
	maddr
;

24 cÚ¡ * 
	mm­_Çme
;

25 cÚ¡ * 
	msymbŞ_Çme
;

26 } 
	tbackŒaû_symbŞ_t
;

33 
size_t
 
backŒaû
(
backŒaû_¡ack_t
 *
¡ack
, size_ˆ
max_d•th
);

41 
backŒaû_symbŞ_t
* 
g‘BackŒaûSymbŞs
(
size_t
 
couÁ
);

46 
ä“BackŒaûSymbŞs
(
backŒaû_symbŞ_t
* 
symbŞs
);

50 
	mMAX_BACKTRACE_LINE_LENGTH
 = 800,

54 
	mMAX_BACKTRACE_DEPTH
 = 32,

	@hlist.h

1 #iâdeà
_KCOMPAT_HLIST_H


2 
	#_KCOMPAT_HLIST_H


	)

19 
	~<¡ddef.h
>

21 
	scds_hli¡_h—d


23 
cds_hli¡_node
 *
	mÃxt
;

26 
	scds_hli¡_node


28 
cds_hli¡_node
 *
	mÃxt
;

29 
cds_hli¡_node
 *
	m´ev
;

33 
šlše
 
	$CDS_INIT_HLIST_HEAD
(
cds_hli¡_h—d
 *
±r
)

35 
±r
->
Ãxt
 = 
NULL
;

36 
	}
}

39 
	#cds_hli¡_’Œy
(
±r
, 
ty³
, 
memb”
) \

40 ((
ty³
 *è((*è(
±r
è- (è(&(Ñy³ *è0)->
memb”
)))

	)

43 
	#cds_hli¡_fœ¡_’Œy
(
±r
, 
ty³
, 
memb”
) \

44 
	`cds_li¡_’Œy
((
±r
)->
Ãxt
, 
ty³
, 
memb”
)

	)

46 
šlše
 
	$cds_hli¡_em±y
(
cds_hli¡_h—d
 *
h—d
)

48  !
h—d
->
Ãxt
;

49 
	}
}

52 
šlše
 
	$cds_hli¡_add_h—d
 (
cds_hli¡_node
 *
Ãwp
,

53 
cds_hli¡_h—d
 *
h—d
)

55 ià(
h—d
->
Ãxt
)

56 
h—d
->
Ãxt
->
´ev
 = 
Ãwp
;

58 
Ãwp
->
Ãxt
 = 
h—d
->next;

59 
Ãwp
->
´ev
 = (
cds_hli¡_node
 *)
h—d
;

60 
h—d
->
Ãxt
 = 
Ãwp
;

61 
	}
}

64 
šlše
 
	$cds_hli¡_d–
 (
cds_hli¡_node
 *
–em
)

66 ià(
–em
->
Ãxt
)

67 
–em
->
Ãxt
->
´ev
 =ƒlem->prev;

69 
–em
->
´ev
->
Ãxt
 =ƒlem->next;

70 
	}
}

72 
	#cds_hli¡_fÜ_—ch_’Œy
(
’Œy
, 
pos
, 
h—d
, 
memb”
) \

73 
pos
 = (
h—d
)->
Ãxt
, \

74 
’Œy
 = 
	`cds_hli¡_’Œy
(
pos
, 
	`__ty³of__
(*’Œy), 
memb”
); \

75 
pos
 !ğ
NULL
; \

76 
pos
 =…os->
Ãxt
, \

77 
’Œy
 = 
	`cds_hli¡_’Œy
(
pos
, 
	`__ty³of__
(*’Œy), 
memb”
))

	)

79 
	#cds_hli¡_fÜ_—ch_’Œy_§ã
(
’Œy
, 
pos
, 
p
, 
h—d
, 
memb”
) \

80 
pos
 = (
h—d
)->
Ãxt
, \

81 
’Œy
 = 
	`cds_hli¡_’Œy
(
pos
, 
	`__ty³of__
(*’Œy), 
memb”
); \

82 (
pos
 !ğ
NULL
è&& ({ 
p
 =…os->
Ãxt
; 1;}); \

83 
pos
 = 
p
, \

84 
’Œy
 = 
	`cds_hli¡_’Œy
(
pos
, 
	`__ty³of__
(*’Œy), 
memb”
))

	)

	@jhash.h

19 #ià(
defšed
(
__lšux__
è|| defšed(
__CYGWIN__
))

20 
	~<’dŸn.h
>

21 #–ià
defšed
(
__F»eBSD__
)

22 
	~<machše/’dŸn.h
>

33 
	#rÙ
(
x
, 
k
è(((xè<< (k)è| ((xè>> (32 - (k))))

	)

35 
	#mix
(
a
, 
b
, 
c
) \

37 
a
 -ğ
c
;‡ ^ğ
	`rÙ
(c, 4); c +ğ
b
; \

38 
b
 -ğ
a
; b ^ğ
	`rÙ
×, 6);‡ +ğ
c
; \

39 
c
 -ğ
b
; c ^ğ
	`rÙ
(b, 8); b +ğ
a
; \

40 
a
 -ğ
c
;‡ ^ğ
	`rÙ
(c, 16); c +ğ
b
; \

41 
b
 -ğ
a
; b ^ğ
	`rÙ
×, 19);‡ +ğ
c
; \

42 
c
 -ğ
b
; c ^ğ
	`rÙ
(b, 4); b +ğ
a
; \

43 } 0)

	)

45 
	#fš®
(
a
, 
b
, 
c
) \

47 
c
 ^ğ
b
; c -ğ
	`rÙ
(b, 14); \

48 
a
 ^ğ
c
;‡ -ğ
	`rÙ
(c, 11); \

49 
b
 ^ğ
a
; b -ğ
	`rÙ
(a, 25); \

50 
c
 ^ğ
b
; c -ğ
	`rÙ
(b, 16); \

51 
a
 ^ğ
c
;‡ -ğ
	`rÙ
(c, 4);\

52 
b
 ^ğ
a
; b -ğ
	`rÙ
(a, 14); \

53 
c
 ^ğ
b
; c -ğ
	`rÙ
(b, 24); \

54 }

	)

56 #ià(
BYTE_ORDER
 =ğ
LITTLE_ENDIAN
)

57 
	#HASH_LITTLE_ENDIAN
 1

	)

59 
	#HASH_LITTLE_ENDIAN
 0

	)

88 
ušt32_t
 
	$hashl™e
(cÚ¡ *
key
, 
size_t
 
Ëngth
, 
ušt32_t
 
š™v®
)

90 
ušt32_t
 
a
, 
b
, 
c
;

92 cÚ¡ *
±r
;

93 
size_t
 
i
;

94 } 
u
;

97 
a
 = 
b
 = 
c
 = 0xd—db“à+ ((
ušt32_t
)
Ëngth
è+ 
š™v®
;

99 
u
.
±r
 = 
key
;

100 ià(
HASH_LITTLE_ENDIAN
 && ((
u
.
i
 & 0x3) == 0)) {

101 cÚ¡ 
ušt32_t
 *
k
 = (cÚ¡ ušt32_ˆ*è
key
;

104 
Ëngth
 > 12) {

105 
a
 +ğ
k
[0];

106 
b
 +ğ
k
[1];

107 
c
 +ğ
k
[2];

108 
	`mix
(
a
, 
b
, 
c
);

109 
Ëngth
 -= 12;

110 
k
 += 3;

123 #iâdeà
VALGRIND


125 
Ëngth
) {

126 12: 
c
+=
k
[2]; 
b
+=k[1]; 
a
+=k[0]; ;

127 11: 
c
+=
k
[2]&0xffffff; 
b
+=k[1]; 
a
+=k[0]; ;

128 10: 
c
+=
k
[2]&0xffff; 
b
+=k[1]; 
a
+=k[0]; ;

129 9 : 
c
+=
k
[2]&0xff; 
b
+=k[1]; 
a
+=k[0]; ;

130 8 : 
b
+=
k
[1]; 
a
+=k[0]; ;

131 7 : 
b
+=
k
[1]&0xffffff; 
a
+=k[0]; ;

132 6 : 
b
+=
k
[1]&0xffff; 
a
+=k[0]; ;

133 5 : 
b
+=
k
[1]&0xff; 
a
+=k[0]; ;

134 4 : 
a
+=
k
[0]; ;

135 3 : 
a
+=
k
[0]&0xffffff; ;

136 2 : 
a
+=
k
[0]&0xffff; ;

137 1 : 
a
+=
k
[0]&0xff; ;

138 0 :  
c
;

143 cÚ¡ 
ušt8_t
 *
k8
;

145 
k8
 = (cÚ¡ 
ušt8_t
 *è
k
;

146 
Ëngth
) {

147 12: 
c
+=
k
[2]; 
b
+=k[1]; 
a
+=k[0]; ;

148 11: 
c
+=((
ušt32_t
è
k8
[10])<<16;

149 10: 
c
+=((
ušt32_t
è
k8
[9])<<8;

150 9 : 
c
+=
k8
[8];

151 8 : 
b
+=
k
[1]; 
a
+=k[0]; ;

152 7 : 
b
+=((
ušt32_t
è
k8
[6])<<16;

153 6 : 
b
+=((
ušt32_t
è
k8
[5])<<8;

154 5 : 
b
+=
k8
[4];

155 4 : 
a
+=
k
[0]; ;

156 3 : 
a
+=((
ušt32_t
è
k8
[2])<<16;

157 2 : 
a
+=((
ušt32_t
è
k8
[1])<<8;

158 1 : 
a
+=
k8
[0]; ;

159 0 :  
c
;

164 } ià(
HASH_LITTLE_ENDIAN
 && ((
u
.
i
 & 0x1) == 0)) {

165 cÚ¡ 
ušt16_t
 *
k
 = (cÚ¡ ušt16_ˆ*è
key
;

166 cÚ¡ 
ušt8_t
 *
k8
;

169 
Ëngth
 > 12)

171 
a
 +ğ
k
[0] + (((
ušt32_t
) k[1])<<16);

172 
b
 +ğ
k
[2] + (((
ušt32_t
) k[3])<<16);

173 
c
 +ğ
k
[4] + (((
ušt32_t
) k[5])<<16);

174 
	`mix
(
a
, 
b
, 
c
);

175 
Ëngth
 -= 12;

176 
k
 += 6;

180 
k8
 = (cÚ¡ 
ušt8_t
 *è
k
;

181 
Ëngth
)

183 12: 
c
+=
k
[4]+(((
ušt32_t
) k[5])<<16);

184 
b
+=
k
[2]+(((
ušt32_t
) k[3])<<16);

185 
a
+=
k
[0]+(((
ušt32_t
) k[1])<<16);

187 11: 
c
+=((
ušt32_t
è
k8
[10])<<16;

188 10: 
c
+=
k
[4];

189 
b
+=
k
[2]+(((
ušt32_t
) k[3])<<16);

190 
a
+=
k
[0]+(((
ušt32_t
) k[1])<<16);

192 9 : 
c
+=
k8
[8];

193 8 : 
b
+=
k
[2]+(((
ušt32_t
) k[3])<<16);

194 
a
+=
k
[0]+(((
ušt32_t
) k[1])<<16);

196 7 : 
b
+=((
ušt32_t
è
k8
[6])<<16;

197 6 : 
b
+=
k
[2];

198 
a
+=
k
[0]+(((
ušt32_t
) k[1])<<16);

200 5 : 
b
+=
k8
[4];

201 4 : 
a
+=
k
[0]+(((
ušt32_t
) k[1])<<16);

203 3 : 
a
+=((
ušt32_t
è
k8
[2])<<16;

204 2 : 
a
+=
k
[0];

206 1 : 
a
+=
k8
[0];

208 0 :  
c
;

212 cÚ¡ 
ušt8_t
 *
k
 = (cÚ¡ ušt8_ˆ*)
key
;

215 
Ëngth
 > 12) {

216 
a
 +ğ
k
[0];

217 
a
 +ğ((
ušt32_t
è
k
[1])<<8;

218 
a
 +ğ((
ušt32_t
è
k
[2])<<16;

219 
a
 +ğ((
ušt32_t
è
k
[3])<<24;

220 
b
 +ğ
k
[4];

221 
b
 +ğ((
ušt32_t
è
k
[5])<<8;

222 
b
 +ğ((
ušt32_t
è
k
[6])<<16;

223 
b
 +ğ((
ušt32_t
è
k
[7])<<24;

224 
c
 +ğ
k
[8];

225 
c
 +ğ((
ušt32_t
è
k
[9])<<8;

226 
c
 +ğ((
ušt32_t
è
k
[10])<<16;

227 
c
 +ğ((
ušt32_t
è
k
[11])<<24;

228 
	`mix
(
a
,
b
,
c
);

229 
Ëngth
 -= 12;

230 
k
 += 12;

234 
Ëngth
) {

235 12: 
c
+=((
ušt32_t
è
k
[11])<<24;

236 11: 
c
+=((
ušt32_t
è
k
[10])<<16;

237 10: 
c
+=((
ušt32_t
è
k
[9])<<8;

238 9 : 
c
+=
k
[8];

239 8 : 
b
+=((
ušt32_t
è
k
[7])<<24;

240 7 : 
b
+=((
ušt32_t
è
k
[6])<<16;

241 6 : 
b
+=((
ušt32_t
è
k
[5])<<8;

242 5 : 
b
+=
k
[4];

243 4 : 
a
+=((
ušt32_t
è
k
[3])<<24;

244 3 : 
a
+=((
ušt32_t
è
k
[2])<<16;

245 2 : 
a
+=((
ušt32_t
è
k
[1])<<8;

246 1 : 
a
+=
k
[0];

248 0 :  
c
;

252 
	`fš®
(
a
, 
b
, 
c
);

253  
c
;

254 
	}
}

256 
šlše


257 
ušt32_t
 
	$jhash
(cÚ¡ *
key
, 
size_t
 
Ëngth
, 
ušt32_t
 
£ed
)

259  
	`hashl™e
(
key
, 
Ëngth
, 
£ed
);

260 
	}
}

	@memleakfinder.c

1 
	~<¡dio.h
>

2 
	~<dlfú.h
>

3 
	~<±h»ad.h
>

4 
	~<sys/ty³s.h
>

5 
	~<sys/¡©.h
>

6 
	~<fú.h
>

7 
	~<¡ršg.h
>

8 
	~<”ºo.h
>

9 
	~<ªdroid/log.h
>

10 
	~"hli¡.h
"

11 
	~"jhash.h
"

12 
	~"backŒaû.h
"

14 
	#TAG
 "MemÜyL—kFšd”"

	)

16 
	#STATIC_BUF_LEN
 8192

	)

17 
	g¡©ic_buf
[
STATIC_BUF_LEN
];

18 
size_t
 
	g¡©ic_buf_Ën
;

20 
±h»ad_mu‹x_t
 
	gmh_mu‹x
 = 
PTHREAD_MUTEX_INITIALIZER
;

21 
±h»ad_mu‹x_t
 
	g¡©ic_®loc_mu‹x
 = 
PTHREAD_MUTEX_INITIALIZER
;

23 
±h»ad_key_t
 
	gth»ad_key
;

24 
±h»ad_Úû_t
 
	gš™_dÚe
 = 
PTHREAD_ONCE_INIT
;

26 *(*
	gm®loı
)(
	gsize_t
);

27 (*
ä“p
)(*);

29 
	#MH_HASH_BITS
 20

	)

30 
	#MH_TABLE_SIZE
 (1 << 
MH_HASH_BITS
)

	)

31 
cds_hli¡_h—d
 
mh_bË
[
MH_TABLE_SIZE
];

32 
size_t
 
®loûd_size
;

33 
size_t
 
ä“d_size
;

34 
size_t
 
®loûd_n
;

36 
	#FILTER_SIZE
 16

	)

37 cÚ¡ * 
cÚfig_fe
 = "/data/local/tmp/memleakconfig.txt";

38 *
ÿÎ”_f‹r
[
FILTER_SIZE
];

40 
	smh_’Œy
 {

41 
cds_hli¡_node
 
hli¡
;

42 *
±r
;

43 
size_t
 
®loc_size
;

44 
backŒaû_¡ack_t
 
¡ack
;

47 
mh_’Œy
 *
	$g‘_mh
(cÚ¡ *
±r
)

49 
cds_hli¡_h—d
 *
h—d
;

50 
cds_hli¡_node
 *
node
;

51 
mh_’Œy
 *
e
;

52 
ušt32_t
 
hash
;

54 
hash
 = 
	`jhash
(&
±r
, (ptr), 0);

55 
h—d
 = &
mh_bË
[
hash
 & (
MH_TABLE_SIZE
 - 1)];

56 
	`cds_hli¡_fÜ_—ch_’Œy
(
e
, 
node
, 
h—d
, 
hli¡
) {

57 ià(
±r
 =ğ
e
->ptr)

58  
e
;

60  
NULL
;

61 
	}
}

63 
	$add_mh
(*
±r
, 
size_t
 
®loc_size
, 
backŒaû_¡ack_t
 *
¡ack
)

65 
cds_hli¡_h—d
 *
h—d
;

66 
cds_hli¡_node
 *
node
;

67 
mh_’Œy
 *
e
;

68 
ušt32_t
 
hash
;

69 
Dl_šfo
 
šfo
;

71 ià(!
±r
)

74 
hash
 = 
	`jhash
(&
±r
, (ptr), 0);

75 
h—d
 = &
mh_bË
[
hash
 & (
MH_TABLE_SIZE
 - 1)];

76 
	`cds_hli¡_fÜ_—ch_’Œy
(
e
, 
node
, 
h—d
, 
hli¡
) {

77 ià(
±r
 =ğ
e
->ptr) {

83 
e
 = (
mh_’Œy
 *)
	`m®loı
((*e));

84 
e
->
±r
 =…tr;

85 
e
->
®loc_size
 =‡lloc_size;

86 
e
->
¡ack
 = *stack;

88 
	`cds_hli¡_add_h—d
(&
e
->
hli¡
, 
h—d
);

90 
®loûd_size
 +ğ
®loc_size
;

91 ++
®loûd_n
;

92 
	}
}

94 
	$d–_mh
(*
±r
)

96 
mh_’Œy
 *
e
;

98 ià(!
±r
)

101 
e
 = 
	`g‘_mh
(
±r
);

102 ià(!
e
) {

106 
	`cds_hli¡_d–
(&
e
->
hli¡
);

107 
	`ä“p
(
e
);

109 
ä“d_size
 +ğ
e
->
®loc_size
;

110 --
®loûd_n
;

111 
	}
}

113 
	$th»ad_key_š™
()

115 
	`±h»ad_key_ü—‹
(&
th»ad_key
, 
NULL
);

116 
	}
}

118 
__©Œibu‹__
((
cÚ¡ruùÜ
))

119 
	$š™
()

121 
	`±h»ad_Úû
(&
š™_dÚe
, 
th»ad_key_š™
);

123 
m®loı
 = (*(*è(
size_t
)è
	`dlsym
 (
RTLD_NEXT
, "malloc");

124 
ä“p
 = ((*è(*)è
	`dlsym
 (
RTLD_NEXT
, "free");

125 
	}
}

127 *
	$¡©ic_®loc
(
size_t
 
n
, size_ˆ
size
)

129 *
»Œ
 = 
NULL
;

131 
	`±h»ad_mu‹x_lock
(&
¡©ic_®loc_mu‹x
);

133 ià(
n
 * 
size
 > (
¡©ic_buf
è- 
¡©ic_buf_Ën
) {

134 
	`±h»ad_mu‹x_uÆock
(&
¡©ic_®loc_mu‹x
);

135  
NULL
;

138 
»Œ
 = 
¡©ic_buf
 + 
¡©ic_buf_Ën
;

139 
¡©ic_buf_Ën
 +ğ
n
 * 
size
;

141 
	`±h»ad_mu‹x_uÆock
(&
¡©ic_®loc_mu‹x
);

143  
»Œ
;

144 
	}
}

146 *
	$m®loc
(
size_t
 
size
)

148 *
»suÉ
;

150 ià(
m®loı
 =ğ
NULL
) {

151 
	`š™
();

152 
»suÉ
 = 
	`¡©ic_®loc
(1, 
size
);

153  
»suÉ
;

156 
»suÉ
 = 
	`m®loı
(
size
);

158 ià(
	`±h»ad_g‘¥ecific
(
th»ad_key
)) {

159  
»suÉ
;

162 
	`±h»ad_£t¥ecific
(
th»ad_key
, (*)0x01);

167 
backŒaû_¡ack_t
 
¡k
;

168 
n
 = 
	`backŒaû
(&
¡k
, 10);

170 
	`±h»ad_mu‹x_lock
(&
mh_mu‹x
);

171 ià(
n
 > 0) {

172 
	`add_mh
(
»suÉ
, 
size
, &
¡k
);

174 
	`±h»ad_mu‹x_uÆock
(&
mh_mu‹x
);

176 
	`±h»ad_£t¥ecific
(
th»ad_key
, 
NULL
);

178  
»suÉ
;

179 
	}
}

181 
	$ä“
(*
±r
)

183 ià(
±r
 >ğ(*è
¡©ic_buf
 &&…Œ < (*)(¡©ic_buà+ 
STATIC_BUF_LEN
)) {

186 
	`ä“p
(
±r
);

189 
	`±h»ad_mu‹x_lock
(&
mh_mu‹x
);

190 
	`d–_mh
(
±r
);

191 
	`±h»ad_mu‹x_uÆock
(&
mh_mu‹x
);

192 
	}
}

194 
	$»ad_cÚfig
()

196 
FILE
 *
å
 = 
NULL
;

197 
lše_buf
[256] = {0};

198 
i
 = 0;

201 
i
 = 0; i < 
FILTER_SIZE
; ++i) {

202 ià(
ÿÎ”_f‹r
[
i
]) {

203 
	`ä“
(
ÿÎ”_f‹r
[
i
]);

204 
ÿÎ”_f‹r
[
i
] = 
NULL
;

208 ià((
å
 = 
	`fİ’
(
cÚfig_fe
, "r")è=ğ
NULL
) {

209 
	`__ªdroid_log_´št
(
ANDROID_LOG_DEBUG
, "MemoryLeakFinder",

210 "O³ÀcÚfig f% çed", 
cÚfig_fe
);

214 
i
 = 0;

215 !
	`ãof
(
å
)) {

216 
lše_buf
[0] = '\0';

217 
	`fsÿnf
(
å
, "%s", 
lše_buf
);

219 
	`__ªdroid_log_´št
(
ANDROID_LOG_DEBUG
, "MemoryLeakFinder",

220 "»ad cÚfiglš%s,†’ %d", 
lše_buf
, 
	`¡¾’
(line_buf));

222 ià(
	`¡¾’
(
lše_buf
) > 0) {

223 
ÿÎ”_f‹r
[
i
++] = 
	`¡rdup
(
lše_buf
);

225 ià(
i
 =ğ
FILTER_SIZE
) {

230 
	`fşo£
(
å
);

231 
	}
}

233 
	$m©ch_¡ack
(
mh_’Œy
 *
e
)

235 
Dl_šfo
 
šfo
;

236 *
fe_Çme
 = 
NULL
;

237 ià(!
e
)  0;

239 
i
 = 0; i < 
e
->
¡ack
.
n
; ++i) {

240 
	`dÏddr
(
e
->
¡ack
.
s
[
i
], &
šfo
);

241 
j
 = 0; j < 
FILTER_SIZE
; ++j) {

242 ià(
ÿÎ”_f‹r
[
j
] && 
šfo
.
dli_âame
 && 
	`¡r¡r
(info.dli_fname, caller_filter[j])) {

249 
	}
}

251 
	$´št_Ëaks
()

253 
size_t
 
i
 = 0;

254 
size_t
 
út
 = 0;

255 
j
 = 0;

256 
logbuf
[256] = {0};

258 
	`±h»ad_£t¥ecific
(
th»ad_key
, (*)0x01);

260 
	`±h»ad_mu‹x_lock
(&
mh_mu‹x
);

262 
	`»ad_cÚfig
();

264 
	`__ªdroid_log_´št
(
ANDROID_LOG_DEBUG
, "MemoryLeakFinder",

266 
®loûd_n
, 
®loûd_size
, 
ä“d_size
,‡lloced_size - freed_size);

268 
i
 = 0; i < 
MH_TABLE_SIZE
; ++i) {

269 
cds_hli¡_h—d
 *
h—d
;

270 
cds_hli¡_node
 *
node
;

271 
mh_’Œy
 *
e
;

273 
h—d
 = &
mh_bË
[
i
];

276 
	`cds_hli¡_fÜ_—ch_’Œy
(
e
, 
node
, 
h—d
, 
hli¡
) {

277 
Dl_šfo
 
šfo
;

278 *
ÿÎ”_symbŞ
 = 
NULL
;

279 *
fe_Çme
 = 
NULL
;

281 ià(!
	`m©ch_¡ack
(
e
)) {

285 
i
 = 1; i < 
e
->
¡ack
.
n
; ++i) {

286 
	`dÏddr
(
e
->
¡ack
.
s
[
i
], &
šfo
);

287 ià(
šfo
.
dli_¢ame
) {

288 
ÿÎ”_symbŞ
 = 
	`¡rdup
(
šfo
.
dli_¢ame
);

290 ià(
šfo
.
dli_âame
) {

291 
fe_Çme
 = 
	`¡rdup
(
šfo
.
dli_âame
);

295 
	`__ªdroid_log_´št
(
ANDROID_LOG_DEBUG
, "MemoryLeakFinder",

297 
i
, 
fe_Çme
 =ğ
NULL
 ? "Unknown" : file_name,

298 
ÿÎ”_symbŞ
 =ğ
NULL
 ? "Unknown" : caller_symbol);

300 ià(
ÿÎ”_symbŞ
) {

301 
	`ä“p
(
ÿÎ”_symbŞ
);

302 
ÿÎ”_symbŞ
 = 
NULL
;

304 ià(
fe_Çme
) {

305 
	`ä“p
(
fe_Çme
);

306 
fe_Çme
 = 
NULL
;

315 
	`__ªdroid_log_´št
(
ANDROID_LOG_DEBUG
, "MemoryLeakFinder",

318 
®loûd_n
, 
út
);

320 
çed
:

321 
	`±h»ad_mu‹x_uÆock
(&
mh_mu‹x
);

323 
	`±h»ad_£t¥ecific
(
th»ad_key
, 
NULL
);

324 
	}
}

	@stackfilter.c

1 
	~<¡dio.h
>

	@stats.c

1 
	~<¡dio.h
>

2 
	~<sigÇl.h
>

3 
	~<ªdroid/log.h
>

5 
	#STAT_SIGNAL
 
SIGUSR2


	)

7 
´št_Ëaks
();

9 
	$sighªdËr
(
signo
, 
sigšfo_t
 *
sigšfo
, *
cÚ‹xt
)

12 
	`´št_Ëaks
();

13 
	}
}

15 
__©Œibu‹__
((
cÚ¡ruùÜ
))

16 
	$¡©s_š™
()

20 
sigaùiÚ
 
aù
;

21 
aù
.
§_sigaùiÚ
 = 
sighªdËr
;

22 
aù
.
§_æags
 = 
SA_SIGINFO
 | 
SA_RESTART
;

23 
	`sigem±y£t
(&
aù
.
§_mask
);

24 
	`sigaùiÚ
(
STAT_SIGNAL
, &
aù
, 
NULL
);

25 
	}
}

	@
1
.
0
7
78
backtrace.c
backtrace.h
hlist.h
jhash.h
memleakfinder.c
stackfilter.c
stats.c
